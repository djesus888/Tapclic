<script setup>
import { onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useConversationStore } from '@/stores/conversationStore'
import { useAuthStore } from '@/stores/authStore'
import { formatDistanceToNow } from 'date-fns'


const authStore   = useAuthStore()
const chatStore   = useConversationStore()
const router      = useRouter()

onMounted(() => {
  chatStore.fetchConversations()
  if (authStore.user) {
    chatStore.initSocket(authStore.user.id)
  }
})

function openChat(conversationId) {
  chatStore.goToChat(conversationId, router)
}
</script>

<template>
  <div class="max-w-2xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Mis Conversaciones</h1>

    <div v-if="chatStore.conversations.length === 0" class="text-center text-gray-500 py-10">
      ðŸ“­ No tienes conversaciones todavÃ­a.
    </div>

    <ul v-else class="space-y-3">
      <li
        v-for="conv in chatStore.conversations"
        :key="conv.id"
        @click="openChat(conv.id)"
        class="flex items-center gap-4 p-3 bg-white rounded-lg shadow cursor-pointer hover:bg-gray-50 transition"
      >
        <!-- Avatar / Iniciales -->
        <div
          class="w-12 h-12 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-xl"
        >
          {{ conv.participants[0]?.charAt(0).toUpperCase() || '?' }}
        </div>

        <!-- Info -->
        <div class="flex-1 min-w-0">
          <p class="font-semibold truncate">
            {{ conv.participants.join(', ') }}
          </p>
          <p class="text-sm text-gray-600 truncate">
            {{ conv.lastMessage?.text || 'Sin mensajes' }}
          </p>
        </div>

        <!-- Meta -->
        <div class="text-right text-sm">
          <p class="text-gray-500">
            {{ conv.lastMessage?.created_at
               ? formatDistanceToNow(new Date(conv.lastMessage.created_at))
               : '' }}
          </p>
          <span
            v-if="conv.unreadCount > 0"
            class="inline-block bg-red-500 text-white rounded-full px-2 py-0.5 text-xs font-bold"
          >
            {{ conv.unreadCount }}
          </span>
        </div>
      </li>
    </ul>
  </div>
</template>
